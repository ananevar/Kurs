@page "/meters"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using JKH.Data
@using JKH.Models
@implements IAsyncDisposable
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Счётчики</PageTitle>

<h1>Счётчики — @PropertyTitle</h1>

<p>
    <a href="@($"/meters/create?propertyId={propertyId}")">Добавить счётчик</a>
</p>
<p>
    <a href="@BackUrl">Назад</a>
</p>

<QuickGrid Class="table" Items="_items">
    <PropertyColumn Title="Услуга" Property="m => m.ServiceType.Name" />
    <PropertyColumn Title="Серийный №" Property="m => m.SerialNumber" />
    <PropertyColumn Title="Установлен" Property="m => m.InstalledAt" />
    <PropertyColumn Title="Активен" Property="m => m.IsActive" />
    <PropertyColumn Title="Показаний" Property="m => m.Readings.Count" />

    <TemplateColumn Context="m" Title="Действия">
        <a href="@($"/readings?meterId={m.Id}")">Показания</a>
        |
        <a href="@($"/meters/edit?id={m.Id}")">Edit</a>
        |
        <a href="@($"/meters/delete?id={m.Id}")">Delete</a>
    </TemplateColumn>
</QuickGrid>

@code {
    [SupplyParameterFromQuery] public int? propertyId { get; set; }

    private ApplicationDbContext _db = default!;
    private IQueryable<Meter> _items = default!;

    public string PropertyTitle { get; set; } = "";

    private int? _buildingId;
    private string BackUrl => _buildingId.HasValue ? $"/properties?buildingId={_buildingId}" : "/properties";

    protected override async Task OnInitializedAsync()
    {
        _db = await DbFactory.CreateDbContextAsync();

        if (!propertyId.HasValue)
        {
            NavigationManager.NavigateTo("/notfound");
            return;
        }

        var prop = await _db.Properties
            .AsNoTracking()
            .Include(p => p.Building)
                .ThenInclude(b => b.Street)
                    .ThenInclude(s => s.District)
                        .ThenInclude(d => d.City)
            .FirstOrDefaultAsync(p => p.Id == propertyId.Value);

        if (prop is null)
        {
            NavigationManager.NavigateTo("/notfound");
            return;
        }

        _buildingId = prop.BuildingId;
        PropertyTitle =
            $"{prop.Building.Street.District.City.Name}, {prop.Building.Street.Name}, {prop.Building.Number}, кв. {prop.Apartment}";

        _items = _db.Meters
            .Include(m => m.ServiceType)
            .Include(m => m.Readings)
            .AsNoTracking()
            .Where(m => m.PropertyId == propertyId.Value)
            .OrderBy(m => m.ServiceType.Name)
            .ThenBy(m => m.SerialNumber);
    }

    public async ValueTask DisposeAsync()
    {
        if (_db is not null)
            await _db.DisposeAsync();
    }
}
