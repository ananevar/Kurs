@page "/admin/users/edit/{Id}"
@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using JKH.Data

@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Редактирование пользователя</PageTitle>

<h1>Редактирование</h1>

@if (user is null)
{
    <p>Не найден.</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Email</label>
            <InputText class="form-control" @bind-Value="model.Email" />
        </div>

        <div class="mb-3">
            <label class="form-label">UserName</label>
            <InputText class="form-control" @bind-Value="model.UserName" />
        </div>

        <div class="mb-3">
            <label class="form-label">Телефон</label>
            <InputText class="form-control" @bind-Value="model.PhoneNumber" />
        </div>

        <div class="form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="model.EmailConfirmed" />
            <label class="form-check-label">Email подтверждён</label>
        </div>

        <div class="mb-3">
            <label class="form-label">Роль</label>
            <select class="form-select" @bind="model.Role">
                @foreach (var r in roles)
                {
                    <option value="@r">@r</option>
                }
            </select>
            <div class="form-text">У пользователя предполагается одна роль.</div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" disabled="@saving">Сохранить</button>
            <a class="btn btn-outline-secondary" href="/admin/users">Отмена</a>
        </div>

        @if (!string.IsNullOrWhiteSpace(error))
        {
            <div class="alert alert-danger mt-3">@error</div>
        }
        @if (!string.IsNullOrWhiteSpace(ok))
        {
            <div class="alert alert-success mt-3">@ok</div>
        }
    </EditForm>
}

@code {
    [Parameter] public string Id { get; set; } = "";

    private ApplicationUser? user;
    private bool saving;
    private string? error;
    private string? ok;

    private List<string> roles = new();
    private EditUserModel model = new();

    protected override async Task OnParametersSetAsync()
    {
        user = await UserManager.FindByIdAsync(Id);
        if (user is null) return;

        // роли из БД
        roles = RoleManager.Roles
            .Select(r => r.Name!)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .OrderBy(x => x)
            .ToList();

        if (roles.Count == 0)
            roles = new() { "Admin", "Provider", "Consumer" };

        // текущая роль пользователя (берём первую)
        var userRoles = await UserManager.GetRolesAsync(user);
        var currentRole = userRoles.FirstOrDefault();

        var selectedRole = !string.IsNullOrWhiteSpace(currentRole) && roles.Contains(currentRole)
            ? currentRole
            : (roles.Contains("Consumer") ? "Consumer" : roles[0]);

        model = new EditUserModel
        {
            Email = user.Email,
            UserName = user.UserName,
            PhoneNumber = user.PhoneNumber,
            EmailConfirmed = user.EmailConfirmed,
            Role = selectedRole
        };
    }

    private async Task<int> CountAdminsAsync()
    {
        var admins = await UserManager.GetUsersInRoleAsync("Admin");
        return admins.Count;
    }

    private async Task Save()
    {
        if (user is null) return;

        saving = true;
        error = null;
        ok = null;

        // 1) обновляем поля пользователя
        user.Email = model.Email;
        user.UserName = model.UserName;
        user.PhoneNumber = model.PhoneNumber;
        user.EmailConfirmed = model.EmailConfirmed;

        var res = await UserManager.UpdateAsync(user);
        if (!res.Succeeded)
        {
            saving = false;
            error = string.Join("; ", res.Errors.Select(e => e.Description));
            return;
        }

        // 2) обновляем роль (1 роль на пользователя)
        var oldRoles = await UserManager.GetRolesAsync(user);
        var isAdminNow = oldRoles.Contains("Admin");
        var newRole = model.Role;

        // ✅ защита: нельзя снять Admin у последнего админа
        if (isAdminNow && newRole != "Admin")
        {
            var adminCount = await CountAdminsAsync();
            if (adminCount <= 1)
            {
                saving = false;
                error = "Нельзя снять роль Admin у последнего администратора.";
                model.Role = "Admin"; // откат выбора в UI
                return;
            }
        }

        // снять старые
        if (oldRoles.Count > 0)
        {
            var rem = await UserManager.RemoveFromRolesAsync(user, oldRoles);
            if (!rem.Succeeded)
            {
                saving = false;
                error = string.Join("; ", rem.Errors.Select(e => e.Description));
                return;
            }
        }

        // назначить новую
        var add = await UserManager.AddToRoleAsync(user, newRole);
        if (!add.Succeeded)
        {
            saving = false;
            error = string.Join("; ", add.Errors.Select(e => e.Description));
            return;
        }

        saving = false;
        ok = "Сохранено.";
    }

    private class EditUserModel
    {
        [EmailAddress] public string? Email { get; set; }
        [MaxLength(256)] public string? UserName { get; set; }
        [MaxLength(50)] public string? PhoneNumber { get; set; }
        public bool EmailConfirmed { get; set; }

        [Required] public string Role { get; set; } = "Consumer";
    }
}
