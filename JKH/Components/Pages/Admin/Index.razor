@page "/admin/users"
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using JKH.Data
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin,Provider")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole> RoleManager

<PageTitle>Пользователи</PageTitle>

<h1>Пользователи</h1>

<div class="row g-2 mb-3">
    <div class="col-md-6">
        <input class="form-control" placeholder="Поиск (email / username)"
               @bind="q" @bind:event="oninput" />
    </div>
    <div class="col-md-3">
        <button class="btn btn-outline-secondary w-100" @onclick="Load">Обновить</button>
    </div>
</div>

@if (loading)
{
    <p>Загрузка...</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped align-middle">
            <thead>
            <tr>
                <th>Фото</th>
                <th>Email</th>
                <th>UserName</th>
                <th>Телефон</th>
                <th>Email подтверждён</th>
                <th style="width:220px;">Роль</th>
                <th style="width:420px;"></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var u in users)
            {
                <tr>
                    <td>
                        <img src="/user-photo/@u.Id"
                             style="width:40px;height:40px;border-radius:50%;object-fit:cover" />
                    </td>

                    <td>@u.Email</td>
                    <td>@u.UserName</td>
                    <td>@u.PhoneNumber</td>
                    <td>@u.EmailConfirmed</td>
<AuthorizeView Roles="Admin">
    <Authorized>
                    <td>
                        <select class="form-select form-select-sm"
                                value="@GetSelectedRole(u.Id)"
                                @onchange="(e) => OnRoleChanged(u.Id, e.Value?.ToString())">
                            @foreach (var r in roles)
                            {
                                <option value="@r">@r</option>
                            }
                        </select>

                        @if (TryGetMessage(u.Id, out var msg) && !string.IsNullOrWhiteSpace(msg))
                        {
                            <div class="text-muted small mt-1">@msg</div>
                        }
                    </td>

                    <td class="text-end">
                        <button class="btn btn-sm btn-primary me-2"
                                disabled="@IsSaving(u.Id)"
                                @onclick="() => SaveRoleAsync(u.Id)">
                            @(IsSaving(u.Id) ? "..." : "Сохранить роль")
                        </button>

                        <a class="btn btn-sm btn-outline-primary me-1" href="/admin/users/details/@u.Id">Просмотр</a>
                        <a class="btn btn-sm btn-outline-warning me-1" href="/admin/users/edit/@u.Id">Изменить</a>
                        <a class="btn btn-sm btn-outline-danger" href="/admin/users/delete/@u.Id">Удалить</a>
                    </td>
                    </Authorized>
</AuthorizeView>
                </tr>
                
            }
            </tbody>
        </table>
    </div>

    <p class="text-muted">Всего: @users.Count</p>
}

@code {
    private bool loading = true;
    private string q = "";
    private List<ApplicationUser> users = new();

    // роли
    private List<string> roles = new();

    // выбранная роль на пользователя
    private readonly Dictionary<string, string> selectedRoleByUserId = new();

    // состояния UI
    private readonly Dictionary<string, bool> savingByUserId = new();
    private readonly Dictionary<string, string> messageByUserId = new();

    protected override async Task OnInitializedAsync() => await Load();

    private async Task Load()
    {
        loading = true;

        // 1) роли из БД
        roles = RoleManager.Roles
            .Select(r => r.Name!)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .OrderBy(x => x)
            .ToList();

        if (roles.Count == 0)
            roles = new() { "Admin", "Provider", "Consumer" };

        // 2) пользователи
        await using var db = await DbFactory.CreateDbContextAsync();

        var query = db.Users.AsNoTracking();

        if (!string.IsNullOrWhiteSpace(q))
        {
            var s = q.Trim().ToLower();
            query = query.Where(x =>
                (x.Email != null && x.Email.ToLower().Contains(s)) ||
                (x.UserName != null && x.UserName.ToLower().Contains(s)));
        }

        users = await query
            .OrderBy(x => x.Email)
            .Take(500) // защита от огромного списка
            .ToListAsync();

        // 3) подтянуть текущие роли пользователям (1 роль на пользователя)
        selectedRoleByUserId.Clear();
        savingByUserId.Clear();
        messageByUserId.Clear();

        foreach (var u in users)
        {
            var userRoles = await UserManager.GetRolesAsync(u);
            var current = userRoles.FirstOrDefault();

            var selected = !string.IsNullOrWhiteSpace(current) && roles.Contains(current)
                ? current
                : (roles.Contains("Consumer") ? "Consumer" : roles[0]);

            selectedRoleByUserId[u.Id] = selected;
            savingByUserId[u.Id] = false;
            messageByUserId[u.Id] = "";
        }

        loading = false;
    }

    private string GetSelectedRole(string userId)
        => selectedRoleByUserId.TryGetValue(userId, out var r)
            ? r
            : (roles.Contains("Consumer") ? "Consumer" : (roles.FirstOrDefault() ?? "Consumer"));

    private void OnRoleChanged(string userId, string? role)
    {
        if (string.IsNullOrWhiteSpace(role)) return;
        selectedRoleByUserId[userId] = role;
        messageByUserId[userId] = "";
    }

    private bool IsSaving(string userId)
        => savingByUserId.TryGetValue(userId, out var v) && v;

    private bool TryGetMessage(string userId, out string msg)
        => messageByUserId.TryGetValue(userId, out msg!);

    // ✅ Сколько админов в системе
    private async Task<int> CountAdminsAsync()
    {
        var admins = await UserManager.GetUsersInRoleAsync("Admin");
        return admins.Count;
    }

    private async Task SaveRoleAsync(string userId)
    {
        savingByUserId[userId] = true;
        messageByUserId[userId] = "";

        try
        {
            var user = await UserManager.FindByIdAsync(userId);
            if (user is null)
            {
                messageByUserId[userId] = "Пользователь не найден.";
                return;
            }

            var newRole = GetSelectedRole(userId);

            // Текущие роли пользователя
            var oldRoles = await UserManager.GetRolesAsync(user);
            var isAdminNow = oldRoles.Contains("Admin");

            // ✅ ЗАЩИТА: нельзя снять роль Admin у последнего администратора
            if (isAdminNow && newRole != "Admin")
            {
                var adminCount = await CountAdminsAsync();
                if (adminCount <= 1)
                {
                    // откатить селект обратно на Admin
                    selectedRoleByUserId[userId] = "Admin";
                    messageByUserId[userId] = "Нельзя снять роль Admin у последнего администратора.";
                    return;
                }
            }

            // 1) снять старые роли
            if (oldRoles.Count > 0)
            {
                var rem = await UserManager.RemoveFromRolesAsync(user, oldRoles);
                if (!rem.Succeeded)
                {
                    messageByUserId[userId] = string.Join("; ", rem.Errors.Select(e => e.Description));
                    return;
                }
            }

            // 2) назначить новую
            var add = await UserManager.AddToRoleAsync(user, newRole);
            if (!add.Succeeded)
            {
                messageByUserId[userId] = string.Join("; ", add.Errors.Select(e => e.Description));
                return;
            }

            messageByUserId[userId] = $"Ок: {newRole}";
        }
        catch (Exception ex)
        {
            messageByUserId[userId] = "Ошибка: " + ex.Message;
        }
        finally
        {
            savingByUserId[userId] = false;
        }
    }
}
