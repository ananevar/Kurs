@page "/exportexcel"
@rendermode InteractiveServer
@using ClosedXML.Excel
@using Microsoft.EntityFrameworkCore
@using JKH.Data
@using JKH.Models
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime js
@implements IAsyncDisposable

<PageTitle>Экспорт в Excel</PageTitle>

<h1>Экспорт в Excel</h1>

<button type="button" class="btn btn-success mb-2" @onclick="ExportXLS">
    Экспорт (ServiceTypes + Tariffs) в Excel
</button>

@if (!string.IsNullOrWhiteSpace(msg))
{
    <div class="alert alert-info mt-2">@msg</div>
}

@code {
    private ApplicationDbContext _db = default!;
    private string? msg;

    protected override async Task OnInitializedAsync()
    {
        _db = await DbFactory.CreateDbContextAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_db is not null)
            await _db.DisposeAsync();
    }

    public async Task ExportXLS()
    {
        var bytes = await ExportXLSDataAsync();
        await js.InvokeVoidAsync("BlazorDownloadFile", "JKH_Export.xlsx", bytes);
        msg = "Файл сформирован и отправлен в загрузку.";
    }

    private async Task<byte[]> ExportXLSDataAsync()
    {
        using var workbook = new XLWorkbook();

        // -------- ServiceTypes --------
        var ws1 = workbook.Worksheets.Add("ServiceTypes");
        ws1.Cell(1, 1).Value = "Id";
        ws1.Cell(1, 2).Value = "Name";
        ws1.Cell(1, 3).Value = "Unit";
        ws1.Row(1).Style.Font.Bold = true;

        var serviceTypes = await _db.ServiceTypes.AsNoTracking().OrderBy(x => x.Id).ToListAsync();
        int r = 2;
        foreach (var s in serviceTypes)
        {
            ws1.Cell(r, 1).Value = s.Id;
            ws1.Cell(r, 2).Value = s.Name;
            ws1.Cell(r, 3).Value = s.Unit;
            r++;
        }
        ws1.Columns().AdjustToContents();

        // -------- Tariffs --------
        var ws2 = workbook.Worksheets.Add("Tariffs");
        ws2.Cell(1, 1).Value = "Id";
        ws2.Cell(1, 2).Value = "ServiceTypeId";
        ws2.Cell(1, 3).Value = "PricePerUnit";
        ws2.Cell(1, 4).Value = "ValidFrom";
        ws2.Cell(1, 5).Value = "ValidTo";
        ws2.Row(1).Style.Font.Bold = true;

        var tariffs = await _db.Tariffs.AsNoTracking()
            .OrderByDescending(t => t.ValidFrom)
            .ThenBy(t => t.ServiceTypeId)
            .ToListAsync();

        r = 2;
        foreach (var t in tariffs)
        {
            ws2.Cell(r, 1).Value = t.Id;
            ws2.Cell(r, 2).Value = t.ServiceTypeId;
            ws2.Cell(r, 3).Value = t.PricePerUnit;

            // DateOnly -> строка yyyy-MM-dd (чтобы импорт легко парсился)
            ws2.Cell(r, 4).Value = t.ValidFrom.ToString("yyyy-MM-dd");
            ws2.Cell(r, 5).Value = t.ValidTo?.ToString("yyyy-MM-dd") ?? "";

            r++;
        }
        ws2.Columns().AdjustToContents();

        using var ms = new MemoryStream();
        workbook.SaveAs(ms);
        return ms.ToArray();
    }
}
