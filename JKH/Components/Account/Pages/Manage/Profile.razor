@page "/Account/Manage/Profile"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using JKH.Data
@using JKH.Models
@rendermode InteractiveServer
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<PageTitle>–ü—Ä–æ—Ñ–∏–ª—å</PageTitle>

<h1>–ü—Ä–æ—Ñ–∏–ª—å</h1>

@if (_loading)
{
    <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
}
else if (_user is null)
{
    <div class="alert alert-danger">
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–∏–ª–∏ –≤—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã).
    </div>
}
else
{
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</h5>

                    <img class="rounded-circle mb-3"
                         style="width:160px;height:160px;object-fit:cover;border:1px solid #ddd;"
                         src="@PhotoUrl"
                         alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" />

                    <div class="mb-2">
                        <InputFile OnChange="OnPhotoSelected" accept="image/*" />
                    </div>

                    <div class="d-flex gap-2 justify-content-center mt-3">
                        <button class="btn btn-primary"
                                disabled="@(!_hasNewPhoto || _saving)"
                                @onclick="SavePhoto">
                            @(_saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ç–æ")
                        </button>

                        <button class="btn btn-outline-danger"
                                disabled="@(_saving)"
                                @onclick="RemovePhoto">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(_error))
                    {
                        <div class="alert alert-danger mt-3">@_error</div>
                    }
                    @if (!string.IsNullOrWhiteSpace(_ok))
                    {
                        <div class="alert alert-success mt-3">@_ok</div>
                    }

                    <div class="text-muted mt-3">
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ:
                        @(_photoUpdatedAt?.ToString("yyyy-MM-dd HH:mm:ss") ?? "‚Äî")
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h5>
                    <div class="mb-2"><b>Email:</b> @_user.Email</div>
                    <div class="mb-2"><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> @_user.PhoneNumber</div>
                    <div class="mb-2"><b>Id:</b> @_user.Id</div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private ApplicationUser? _user;
    private bool _loading = true;
    private bool _saving = false;

    private string? _error;
    private string? _ok;

    private byte[]? _newPhotoBytes;
    private string? _newPhotoContentType;
    private bool _hasNewPhoto;

    private DateTime? _photoUpdatedAt;
    private long _photoVer = DateTime.UtcNow.Ticks;

    private string PhotoUrl =>
        _user is null
            ? "/images/user-default.png"
            : $"/user-photo/{_user.Id}?v={_photoVer}";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var principal = authState.User;

            if (principal?.Identity?.IsAuthenticated != true)
                return;

            _user = await UserManager.GetUserAsync(principal);
            if (_user != null)
                await LoadPhotoMeta();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadPhotoMeta()
    {
        using var db = DbFactory.CreateDbContext();
        var photo = await db.UserPhotos.AsNoTracking()
            .FirstOrDefaultAsync(x => x.UserId == _user!.Id);

        _photoUpdatedAt = photo?.UpdatedAt;
        _photoVer = photo?.UpdatedAt.Ticks ?? DateTime.UtcNow.Ticks;
    }

    private async Task OnPhotoSelected(InputFileChangeEventArgs e)
    {
        _error = null;
        _ok = null;

        const long maxSize = 5 * 1024 * 1024;

        if (e.File is null || e.File.Size == 0)
        {
            _error = "–§–∞–π–ª –ø—É—Å—Ç–æ–π.";
            return;
        }

        if (e.File.Size > maxSize)
        {
            _error = "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë).";
            return;
        }

        var ct = e.File.ContentType;
        if (string.IsNullOrWhiteSpace(ct) || !ct.StartsWith("image/"))
            ct = "image/jpeg";

        await using var stream = e.File.OpenReadStream(maxSize);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        _newPhotoBytes = ms.ToArray();
        _newPhotoContentType = ct;
        _hasNewPhoto = _newPhotoBytes.Length > 0;
    }

    // üî• –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î –° –î–ò–ê–ì–ù–û–°–¢–ò–ö–û–ô
    private async Task SavePhoto()
    {
        _error = null;
        _ok = null;

        if (_user is null || !_hasNewPhoto || _newPhotoBytes is null)
        {
            _error = "–ù–µ—Ç —Ñ–æ—Ç–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.";
            return;
        }

        _saving = true;
        try
        {
            using var db = DbFactory.CreateDbContext();

            var entity = await db.UserPhotos
                .FirstOrDefaultAsync(x => x.UserId == _user.Id);

            if (entity is null)
            {
                entity = new UserPhoto { UserId = _user.Id };
                db.UserPhotos.Add(entity);
            }

            entity.Data = _newPhotoBytes;
            entity.ContentType = _newPhotoContentType ?? "image/jpeg";
            entity.UpdatedAt = DateTime.UtcNow;

            await db.SaveChangesAsync();

            // üîé 100% –ø—Ä–æ–≤–µ—Ä–∫–∞
            var check = await db.UserPhotos.AsNoTracking()
                .FirstOrDefaultAsync(x => x.UserId == _user.Id);

            if (check is null)
            {
                _error = "‚ùå –ü–æ—Å–ª–µ SaveChanges –∑–∞–ø–∏—Å—å –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î";
                return;
            }

            _ok = $"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î: bytes={check.Data.Length}, ct={check.ContentType}";

            _photoUpdatedAt = check.UpdatedAt;
            _photoVer = check.UpdatedAt.Ticks;

            _newPhotoBytes = null;
            _hasNewPhoto = false;
        }
        catch (Exception ex)
        {
            _error = "‚ùå EXCEPTION: " + ex.ToString();
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task RemovePhoto()
    {
        _error = null;
        _ok = null;

        if (_user is null) return;

        _saving = true;
        try
        {
            using var db = DbFactory.CreateDbContext();
            var entity = await db.UserPhotos.FirstOrDefaultAsync(x => x.UserId == _user.Id);

            if (entity != null)
            {
                db.UserPhotos.Remove(entity);
                await db.SaveChangesAsync();
            }

            _ok = "–§–æ—Ç–æ —É–¥–∞–ª–µ–Ω–æ.";
            _photoUpdatedAt = null;
            _photoVer = DateTime.UtcNow.Ticks;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }
}
